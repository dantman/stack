name: Auto-Update Repository Index

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'INDEX.md'
      - 'consolidated/**'
      - '.github/workflows/**'
  
  schedule:
    # Run weekly to catch any missed updates
    - cron: '0 0 * * 0'
  
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Generate consolidated files and index
      run: |
        ./scripts/generate-consolidated.sh
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if git diff --quiet INDEX.md consolidated/; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit updated files
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add INDEX.md consolidated/
        git commit -m "chore: auto-update repository index and consolidated files

        - Regenerated INDEX.md with latest configurations
        - Updated consolidated configuration files
        - Refreshed AI context references
        
        [auto-generated by GitHub Action]"
    
    - name: Push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: Create index summary
      if: always()
      run: |
        echo "## 🔍 Repository Index Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "✅ **Index Updated**: New configurations detected and indexed" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **Index Current**: No changes detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📊 **Repository Stats**:" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration files: $(find . -name "*.md" -not -name "README.md" -not -name "INDEX.md" -not -path "./consolidated/*" -not -path "./.git/*" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Consolidated files: $(ls consolidated/*.md 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🤖 **For AI Context**: Use consolidated files for efficient loading" >> $GITHUB_STEP_SUMMARY
